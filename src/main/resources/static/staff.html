<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Staff Dashboard</title>

  <style>
    body {
      font-family: Arial;
      background: #f4f6f8;
      padding: 20px;
    }

    .navbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .navbar button {
      flex: 1;
      padding: 12px;
      background: #388e3c;
      color: white;
      border: none;
      cursor: pointer;
    }

    .navbar button:hover {
      background: #2e7d32;
    }

    .section {
      display: none;
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    .section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #388e3c;
      color: white;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #d32f2f;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }

    .logout-btn:hover {
      background: #b71c1c;
    }

    .error {
      color: red;
      margin-top: 8px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }
  </style>
</head>

<body>

  <div class="header">
    <h2>Staff Inventory Dashboard</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="navbar">
    <button onclick="openProducts()">Products</button>
    <button onclick="openStock()">Stock IN / OUT</button>
    <button onclick="openAlerts()">Alerts</button>
    <button onclick="openTransactions()">Transactions</button>
    <button onclick="openReports()">Reports & Analytics</button>
  </div>

  <!-- PRODUCTS -->
  <div id="productSection" class="section active">
    <h3>Products</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Qty</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </div>

  <!-- STOCK IN / OUT -->
  <div id="stockSection" class="section">
    <h3>Stock IN / OUT</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:400px;">
      <input id="pid" placeholder="Product ID" type="number">
      <input id="qty" placeholder="Quantity" type="number">
    </div>
    <button onclick="stockIn()"
      style="width: 100%; padding: 10px; margin-top: 10px; background: #388e3c; color: white; border: none; cursor: pointer;">Stock
      IN</button>
    <button onclick="stockOut()"
      style="width: 100%; padding: 10px; margin-top: 10px; background: #d32f2f; color: white; border: none; cursor: pointer;">Stock
      OUT</button>
    <div id="stockMsg" style="margin-top:8px;"></div>
    <table style="margin-top:15px;">
      <thead>
        <tr>
          <th>Product ID</th>
          <th>Product Name</th>
          <th>Current Quantity</th>
        </tr>
      </thead>
      <tbody id="stockTable"></tbody>
    </table>
  </div>

  <!-- ALERTS (current low-stock from product quantities vs threshold) -->
  <div id="alertSection" class="section">
    <h3>Low Stock Alerts</h3>
    <p style="color:#666;font-size:13px;">Products whose current quantity is at or below their low-stock threshold.</p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Product</th>
          <th>Category</th>
          <th>Available Qty</th>
        </tr>
      </thead>
      <tbody id="alertTable"></tbody>
    </table>
  </div>

  <!-- TRANSACTIONS -->
  <div id="transactionSection" class="section">
    <h3>Transaction History</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>User</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="transactionTable"></tbody>
    </table>
  </div>

  <!-- REPORTS & ANALYTICS (MODULE 5) -->
  <div id="reportSection" class="section">
    <h3>Reports & Analytics</h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:500px;">
      <div>
        <label for="reportFrom">From Date</label>
        <input id="reportFrom" type="date">
      </div>
      <div>
        <label for="reportTo">To Date</label>
        <input id="reportTo" type="date">
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:500px;margin-top:10px;">
      <div>
        <label for="reportSort">Sort By</label>
        <select id="reportSort" style="width:100%;padding:8px;margin:6px 0;" onchange="renderReportTable()">
          <option value="name">Product Name</option>
          <option value="currentStock">Current Stock</option>
          <option value="totalStockIn">Total Stock In (Date Range)</option>
          <option value="totalStockOut">Total Stock Out (Date Range)</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button onclick="loadReport()"
          style="width: 100%; padding: 10px; margin-top: 10px; background: #388e3c; color: white; border: none; cursor: pointer;">
          Generate Report
        </button>
      </div>
    </div>

    <button onclick="downloadReportPdf()"
      style="width: 100%; padding: 10px; margin-top: 10px; background: #455a64; color: white; border: none; cursor: pointer;">
      Download PDF
    </button>

    <div id="reportMsg" style="margin-top:8px;"></div>

    <table style="margin-top:12px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>SKU</th>
          <th>Name</th>
          <th>Current</th>
          <th>Total IN</th>
          <th>Total OUT</th>
        </tr>
      </thead>
      <tbody id="reportTable"></tbody>
    </table>
  </div>

  <script>
    const base = "http://localhost:8081";
    let reportRows = [];

    function formatDateTime(isoStr) {
      if (!isoStr) return "";
      const d = new Date(isoStr);
      if (isNaN(d.getTime())) return isoStr;
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return day + "-" + month + "-" + year + "  " + hours + ":" + mins;
    }

    function getAuthHeaders() {
      const token = localStorage.getItem("token");
      return {
        "Content-Type": "application/json",
        "Authorization": token ? "Bearer " + token : ""
      };
    }

    function hideAll() {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    }

    function openProducts() {
      hideAll();
      productSection.classList.add('active');
      loadProducts();
    }

    function openStock() {
      hideAll();
      stockSection.classList.add('active');
      loadStockTable();
    }

    function openAlerts() {
      hideAll();
      alertSection.classList.add('active');
      loadAlerts();
    }

    function openTransactions() {
      hideAll();
      transactionSection.classList.add('active');
      loadTransactions();
    }

    function openReports() {
      hideAll();
      reportSection.classList.add('active');
      loadReport();
    }

    function loadProducts() {
      fetch(base + "/api/products", { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(data => {
          productTable.innerHTML = "";
          data.forEach(p => {
            productTable.innerHTML += `
         <tr>
           <td>${p.productId}</td>
           <td>${p.name}</td>
           <td>${p.quantity}</td>
         </tr>`;
          });
        });
    }

    function loadStockTable() {
      fetch(base + "/api/products", { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(data => {
          const tbody = document.getElementById("stockTable");
          tbody.innerHTML = "";
          data.forEach(p => {
            tbody.innerHTML += `
         <tr>
           <td>${p.productId}</td>
           <td>${p.name}</td>
           <td>${p.quantity}</td>
         </tr>`;
          });
        });
    }

    function renderAlertsFromProducts(products) {
      const threshold = (p) => (p.minStockLevel != null && p.minStockLevel > 0) ? p.minStockLevel : 5;
      const lowStock = products.filter(p => p.quantity <= threshold(p));
      alertTable.innerHTML = "";
      lowStock.forEach(p => {
        alertTable.innerHTML += `
        <tr>
          <td>${p.productId}</td>
          <td>${p.name}</td>
          <td>${p.categoryName || "-"}</td>
          <td>${p.quantity}</td>
        </tr>`;
      });
    }

    function loadAlerts() {
      fetch(base + "/api/products", { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(data => {
          renderAlertsFromProducts(data);
        });
    }

    function loadTransactions() {
      fetch(base + "/api/transactions", { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(data => {
          transactionTable.innerHTML = "";
          data.forEach(t => {
            transactionTable.innerHTML += `
            <tr>
              <td>${t.transactionId}</td>
              <td>${t.transactionType}</td>
              <td>${t.product ? t.product.name : 'Unknown'}</td>
              <td>${t.quantity}</td>
              <td>${t.performedBy ? t.performedBy.username : 'Unknown'}</td>
              <td>${formatDateTime(t.transactionDate)}</td>
            </tr>`;
          });
        });
    }

    /* REPORTS (MODULE 5) */
    function buildReportQuery() {
      const from = reportFrom.value ? `from=${encodeURIComponent(reportFrom.value)}` : "";
      const to = reportTo.value ? `to=${encodeURIComponent(reportTo.value)}` : "";
      const parts = [from, to].filter(Boolean);
      return parts.length ? "?" + parts.join("&") : "";
    }

    function loadReport() {
      reportMsg.innerText = "Loading report...";
      reportMsg.className = "";

      fetch(base + "/api/reports/generate" + buildReportQuery(), { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(data => {
          reportRows = Array.isArray(data.rows) ? data.rows : [];
          reportMsg.innerText = `Report generated at: ${formatDateTime(data.generatedAt)} (Rows: ${reportRows.length})`;
          reportMsg.className = "msg";
          renderReportTable();
        })
        .catch(() => {
          reportMsg.innerText = "Failed to load report.";
          reportMsg.className = "error";
        });
    }

    function renderReportTable() {
      const sortBy = reportSort.value || "name";
      const sorted = [...reportRows].sort((a, b) => {
        const av = a?.[sortBy];
        const bv = b?.[sortBy];
        if (typeof av === "number" && typeof bv === "number") return bv - av;
        return String(av ?? "").localeCompare(String(bv ?? ""));
      });

      reportTable.innerHTML = "";
      sorted.forEach(r => {
        reportTable.innerHTML += `
          <tr>
            <td>${r.productId ?? ""}</td>
            <td>${r.sku ?? ""}</td>
            <td>${r.name ?? ""}</td>
            <td>${r.currentStock ?? 0}</td>
            <td>${r.totalStockIn ?? 0}</td>
            <td>${r.totalStockOut ?? 0}</td>
          </tr>`;
      });
    }

    function downloadReportPdf() {
      const url = base + "/api/reports/export/pdf" + buildReportQuery();
      window.open(url, "_blank");
    }

    function checkAlertsOnLoad() {
      fetch(base + "/api/products", { headers: getAuthHeaders() })
        .then(r => r.json())
        .then(products => {
          const threshold = (p) => (p.minStockLevel != null && p.minStockLevel > 0) ? p.minStockLevel : 5;
          const lowStock = products.filter(p => p.quantity <= threshold(p));
          if (lowStock.length > 0) {
            const msg = "Low stock alerts:\n\n"
              + lowStock.map(p => "- " + p.name + " (Available: " + p.quantity + ")").join("\n");
            alert(msg);
            renderAlertsFromProducts(products);
            hideAll();
            alertSection.classList.add('active');
          }
        });
    }

    function stockIn() {
      if (!pid.value || !qty.value) {
        stockMsg.innerText = "Please enter Product ID and Quantity";
        stockMsg.className = "error";
        return;
      }
      fetch(`${base}/api/inventory/stock-in`, {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({
          productId: parseInt(pid.value),
          quantity: parseInt(qty.value)
        })
      })
        .then(r => r.text())
        .then(msg => {
          stockMsg.innerText = msg;
          stockMsg.className = "msg";
          pid.value = "";
          qty.value = "";
          loadProducts();
          loadStockTable();
          checkAlertsOnLoad();
          loadTransactions();
        });
    }

    function stockOut() {
      if (!pid.value || !qty.value) {
        stockMsg.innerText = "Please enter Product ID and Quantity";
        stockMsg.className = "error";
        return;
      }
      fetch(`${base}/api/inventory/stock-out`, {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({
          productId: parseInt(pid.value),
          quantity: parseInt(qty.value)
        })
      })
        .then(r => r.text())
        .then(msg => {
          stockMsg.innerText = msg;
          stockMsg.className = "msg";
          pid.value = "";
          qty.value = "";
          loadProducts();
          loadStockTable();
          checkAlertsOnLoad();
          loadTransactions();
        });
    }

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        window.location.href = "login.html";
      }
    }

    loadProducts();
    checkAlertsOnLoad();
  </script>

</body>

</html>